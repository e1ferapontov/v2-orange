#####################################################################
#	Macros
#####################################################################
# Conditional G28 (home if not already homed)
[gcode_macro CG28]
gcode:
	{% if "xyz" not in printer.toolhead.homed_axes %}
		G28
	{% endif %}

[gcode_macro PREHEAT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(110) %}
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(45) %}
    {% set SOAK = params.SOAK|default(20) %}
        
    M117 Adding convection
    PARKCENTER
    M106 S255
  
    M117 Starting Warmup
    M190 S{BED_TEMP}
  
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={CHAMBER_TEMP} MAXIMUM=65
  
    {% if (SOAK|int) <= 0 %}
  
    {% else %}
      M117 Heat Soak
      {% for timer in range( SOAK|int,0,-1) %}
        #we cycle once a minute, so we can send an update to keep octoprint happy, rather than just sleeping for the entire soak
        M117 Soak: {timer|int}m remaining
        M105
        G4 P60000
        
      {% endfor %}
      M117 Soak Complete
      FLASH_LIGHTS
    {% endif %}
  
    M106 S0
    M117 

[gcode_macro MOTORS_OFF]
gcode:
    M84

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    G28
    QUAD_GANTRY_LEVEL
    G28
    G0 X125 Y125 Z30 F3600
   
[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    G32                            ; home all axes
    G1 Z20 F3000                   ; move nozzle away from bed 

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X125 Y250 F3600            ; park nozzle at rear
    BED_MESH_CLEAR

# Park center of build volume
[gcode_macro PARKCENTER]
gcode:
    CG28                                  																						; home if not already homed
    SAVE_GCODE_STATE NAME=PARKCENTER
    G90                                   																						; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} Z{printer.toolhead.axis_maximum.z/2} F19500	
    RESTORE_GCODE_STATE NAME=PARKCENTER

    